{% extends "layout.html" %}

{% block title %}Registrar Base - SERV. BRASIL SUL - XBOX{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .base-container {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 2rem;
    }

    .base-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .base-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .base-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
    }

    .map-section {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 1rem;
        padding: 1.5rem;
    }

    #base-map {
        height: 600px;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    .info-section {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 1rem;
        padding: 1.5rem;
    }

    .info-card {
        background: rgba(255, 255, 255, 0.03);
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    .info-card h3 {
        margin-bottom: 0.5rem;
        color: var(--accent);
    }

    .coord-display {
        font-family: 'Share Tech Mono', monospace;
        font-size: 1.2rem;
        color: var(--accent);
        margin: 1rem 0;
    }

    .register-btn {
        width: 100%;
        padding: 1rem;
        background: var(--accent);
        color: #000;
        border: none;
        border-radius: 0.5rem;
        font-weight: 700;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .register-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .register-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .warning-box {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #ef4444;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    .success-box {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #22c55e;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    @media (max-width: 1024px) {
        .base-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
</head>

{% block content %}
<div class="base-container">
    <div class="base-header">
        <h1><i class="ri-map-pin-fill" style="color: var(--accent);"></i> Registrar Base</h1>
        <p>Clique no mapa para selecionar a localização da sua base</p>
    </div>

    <div class="base-grid">
        <div class="map-section">
            <h2>Mapa de Chernarus</h2>
            <div id="base-map"></div>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                <i class="ri-information-line"></i> Clique no mapa para selecionar as coordenadas da sua base
            </p>
        </div>

        <div class="info-section">
            <h2>Informações da Base</h2>

            <div id="no-selection" class="warning-box">
                <i class="ri-alert-line"></i> Nenhuma localização selecionada
            </div>

            <div id="selection-info" style="display: none;">
                <div class="info-card">
                    <h3>Coordenadas Selecionadas</h3>
                    <div class="coord-display" id="coord-display">X: 0, Y: 0</div>
                </div>

                <div class="info-card">
                    <h3>Nome da Base (Opcional)</h3>
                    <input type="text" id="base-name" class="search-input" placeholder="Ex: Fortaleza do Texas"
                        maxlength="50">
                </div>

                <div class="info-card">
                    <h3>Raio de Proteção</h3>
                    <p style="color: var(--text-secondary);">50 metros (padrão)</p>
                    <small>Apenas membros do seu clã poderão construir nesta área</small>
                </div>

                <div class="warning-box">
                    <strong><i class="ri-alert-line"></i> ATENÇÃO:</strong><br>
                    • Você só pode registrar 1 base<br>
                    • A localização não pode ser alterada depois<br>
                    • Escolha com cuidado!
                </div>

                <button class="register-btn" id="register-btn" onclick="registerBase()">
                    <i class="ri-save-line"></i> Registrar Base
                </button>
            </div>

            <div id="success-message" style="display: none;" class="success-box">
                <i class="ri-checkbox-circle-line"></i> Base registrada com sucesso!
            </div>
        </div>
    </div>
</div>

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let selectedCoords = null;
    let marker = null;

    // Inicializar mapa
    const map = L.map('base-map', {
        crs: L.CRS.Simple,
        minZoom: -2,
        maxZoom: 4
    });

    const bounds = [[0, 0], [15360, 15360]];
    const image = L.imageOverlay('/static/img/chernarus_map.jpg', bounds).addTo(map);
    map.fitBounds(bounds);

    // Círculo de proteção
    let protectionCircle = null;

    // Click no mapa
    map.on('click', function (e) {
        const latlng = e.latlng;
        const x = Math.round(latlng.lng);
        const y = Math.round(15360 - latlng.lat);

        selectedCoords = { x, y, z: 0 };

        // Remover marker anterior
        if (marker) {
            map.removeLayer(marker);
        }
        if (protectionCircle) {
            map.removeLayer(protectionCircle);
        }

        // Adicionar novo marker
        marker = L.marker(latlng, {
            icon: L.divIcon({
                className: 'custom-marker',
                html: '<div style="background: #f59e0b; width: 20px; height: 20px; border-radius: 50%; border: 3px solid #fff;"></div>',
                iconSize: [20, 20]
            })
        }).addTo(map);

        // Adicionar círculo de proteção (50m)
        protectionCircle = L.circle(latlng, {
            radius: 50,
            color: '#f59e0b',
            fillColor: '#f59e0b',
            fillOpacity: 0.2
        }).addTo(map);

        // Atualizar UI
        document.getElementById('no-selection').style.display = 'none';
        document.getElementById('selection-info').style.display = 'block';
        document.getElementById('coord-display').textContent = `X: ${x}, Y: ${y}`;
    });

    async function registerBase() {
        if (!selectedCoords) {
            alert('Selecione uma localização no mapa primeiro!');
            return;
        }

        const baseName = document.getElementById('base-name').value || null;
        const btn = document.getElementById('register-btn');
        btn.disabled = true;
        btn.textContent = 'Registrando...';

        try {
            const response = await fetch('/api/base/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    coord_x: selectedCoords.x,
                    coord_y: selectedCoords.y,
                    coord_z: selectedCoords.z,
                    name: baseName
                })
            });

            const data = await response.json();

            if (response.ok) {
                document.getElementById('selection-info').style.display = 'none';
                document.getElementById('success-message').style.display = 'block';
                setTimeout(() => {
                    window.location.href = '/clan';
                }, 2000);
            } else {
                alert(data.error || 'Erro ao registrar base');
                btn.disabled = false;
                btn.innerHTML = '<i class="ri-save-line"></i> Registrar Base';
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao registrar base');
            btn.disabled = false;
            btn.innerHTML = '<i class="ri-save-line"></i> Registrar Base';
        }
    }
</script>

<!-- Sistema de Notificações -->
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
{% endblock %}
{% endblock %}
