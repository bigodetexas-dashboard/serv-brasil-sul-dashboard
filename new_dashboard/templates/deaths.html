{% extends "layout.html" %}

{% block title %}{{ _('Tiro na Lata') }} - BIGODETEXAS - XBOX{% endblock %}

{% block extra_head %}
<style>
    body {
        background-image: url("{{ url_for('static', filename='images/deaths_bg.jpg') }}");
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        background-repeat: no-repeat;
    }

    .deaths-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: rgba(20, 20, 30, 0.8);
        border: 1px solid #8B0000;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
    }

    .stat-value {
        font-size: 2em;
        color: #ff4444;
        font-weight: bold;
    }

    .stat-label {
        color: #aaa;
        font-size: 0.9em;
        margin-top: 5px;
    }

    .death-card {
        background: rgba(30, 30, 40, 0.9);
        border-left: 4px solid #8B0000;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
        transition: transform 0.2s;
    }

    .death-card:hover {
        transform: translateX(5px);
        border-left-color: #ff0000;
    }

    .death-card.pvp {
        border-left-color: #ff4444;
    }

    .death-card.animal {
        border-left-color: #ffa500;
    }

    .death-header {
        font-size: 1.1em;
        margin-bottom: 8px;
    }

    .death-details {
        color: #999;
        font-size: 0.9em;
    }

    .death-details span {
        margin-right: 15px;
    }

    .badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 0.8em;
        margin-left: 5px;
    }

    .badge.headshot {
        background: #ff0000;
        color: white;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }

    .page-title {
        text-align: center;
        font-size: 2.5em;
        font-weight: bold;
        color: #ff0000;
        text-shadow: 0 0 10px rgba(255, 0, 0, 0.5), 0 0 20px rgba(255, 0, 0, 0.3);
        margin-bottom: 30px;
        letter-spacing: 2px;
        text-transform: uppercase;
    }

    .page-title .subtitle {
        font-size: 0.6em;
        color: #fff;
        font-weight: normal;
        letter-spacing: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="deaths-container">
    <h1 class="page-title">
        {{ _('TIRO NA LATA') }}
        <br>
        <span class="subtitle">KillFeed</span>
    </h1>

    <!-- Estat√≠sticas -->
    <div class="stats-grid" id="stats">
        <div class="stat-card">
            <div class="stat-value" id="stat-total">-</div>
            <div class="stat-label">{{ _('Total (24h)') }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-pvp">-</div>
            <div class="stat-label">{{ _('PvP') }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-animal">-</div>
            <div class="stat-label">{{ _('Animais') }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-headshots">-</div>
            <div class="stat-label">{{ _('Headshots') }}</div>
        </div>
    </div>

    <!-- Feed de Mortes -->
    <div id="deaths-feed">
        <div class="loading">{{ _('Carregando mortes...') }}</div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Formatar data/hora completa
    function formatDateTime(timestamp) {
        if (!timestamp) return "{{ _('Data desconhecida') }}";

        const date = new Date(timestamp);

        // Dias da semana e meses (tradu√ß√£o simples via JS ou manter padr√£o se o backend n√£o enviar traduzido)
        const diasSemana = ["{{ _('Domingo') }}", "{{ _('Segunda') }}", "{{ _('Ter√ßa') }}", "{{ _('Quarta') }}", "{{ _('Quinta') }}", "{{ _('Sexta') }}", "{{ _('S√°bado') }}"];
        const meses = ["{{ _('Jan') }}", "{{ _('Fev') }}", "{{ _('Mar') }}", "{{ _('Abr') }}", "{{ _('Mai') }}", "{{ _('Jun') }}", "{{ _('Jul') }}", "{{ _('Ago') }}", "{{ _('Set') }}", "{{ _('Out') }}", "{{ _('Nov') }}", "{{ _('Dez') }}"];

        const diaSemana = diasSemana[date.getDay()];
        const dia = date.getDate().toString().padStart(2, '0');
        const mes = meses[date.getMonth()];
        const hora = date.getHours().toString().padStart(2, '0');
        const minuto = date.getMinutes().toString().padStart(2, '0');

        return `${diaSemana}, ${dia} ${mes} - ${hora}:${minuto}`;
    }

    // Carregar estat√≠sticas
    async function loadStats() {
        try {
            const res = await fetch('/api/deaths/stats');
            const data = await res.json();

            document.getElementById('stat-total').textContent = data.total_deaths || 0;
            document.getElementById('stat-pvp').textContent = data.pvp || 0;
            document.getElementById('stat-animal').textContent = data.animal || 0;
            document.getElementById('stat-headshots').textContent = data.headshots || 0;
        } catch (err) {
            console.error('Erro ao carregar stats:', err);
        }
    }

    // Carregar feed de mortes
    async function loadDeaths() {
        try {
            const res = await fetch('/api/deaths/recent?per_page=50');
            const data = await res.json();

            const feed = document.getElementById('deaths-feed');

            if (!data.deaths || data.deaths.length === 0) {
                feed.innerHTML = `<div class="loading">{{ _('Nenhuma morte registrada ainda.') }}</div>`;
                return;
            }

            feed.innerHTML = data.deaths.map(death => {
                const formattedTime = formatDateTime(death.timestamp);

                if (death.death_type === 'pvp') {
                    return `
                        <div class="death-card pvp">
                            <div class="death-header">
                                üî´ <strong>${death.killer}</strong> {{ _('matou') }} <strong>${death.victim}</strong>
                                ${death.is_headshot ? '<span class="badge headshot">HEADSHOT</span>' : ''}
                            </div>
                            <div class="death-details">
                                <span>üìç ${death.location || "{{ _('Desconhecido') }}"}</span>
                                <span>üéØ ${death.weapon || 'N/A'}</span>
                                <span>üìè ${death.distance || 0}m</span>
                                <span>‚è∞ ${formattedTime}</span>
                            </div>
                        </div>
                    `;
                } else {
                    const cause = death.death_cause === 'wolf' ? "{{ _('Lobo') }}" : "{{ _('Urso') }}";
                    const icon = death.death_cause === 'wolf' ? 'üê∫' : 'üêª';
                    return `
                        <div class="death-card animal">
                            <div class="death-header">
                                ${icon} <strong>${death.victim}</strong> {{ _('foi morto por') }} ${cause}
                            </div>
                            <div class="death-details">
                                <span>üìç ${death.location || "{{ _('Desconhecido') }}"}</span>
                                <span>‚è∞ ${formattedTime}</span>
                            </div>
                        </div>
                    `;
                }
            }).join('');

        } catch (err) {
            console.error('Erro ao carregar mortes:', err);
            document.getElementById('deaths-feed').innerHTML =
                `<div class="loading">{{ _('Erro ao carregar mortes. Tente novamente.') }}</div>`;
        }
    }

    // Carregar dados iniciais
    loadStats();
    loadDeaths();

    // Atualizar a cada 30 segundos
    setInterval(() => {
        loadStats();
        loadDeaths();
    }, 30000);
</script>
{% endblock %}