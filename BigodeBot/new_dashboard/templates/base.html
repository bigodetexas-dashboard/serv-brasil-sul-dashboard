{% extends "layout.html" %}

{% block title %}Registrar Base - BIGODETEXAS - XBOX{% endblock %}

{% block extra_head %}
<style>
    .base-container {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 2rem;
    }

    .base-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .base-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .base-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
    }

    .map-section {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 1rem;
        padding: 0;
        overflow: hidden;
        height: 700px;
    }

    .info-section {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 1rem;
        padding: 1.5rem;
        height: fit-content;
    }

    .info-card {
        background: rgba(255, 255, 255, 0.03);
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    .info-card h3 {
        margin-bottom: 0.5rem;
        color: var(--accent);
    }

    .coord-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
    }

    .register-btn {
        width: 100%;
        padding: 1rem;
        background: var(--accent);
        color: #000;
        border: none;
        border-radius: 0.5rem;
        font-weight: 700;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .register-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .register-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .warning-box {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #ef4444;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    .success-box {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #22c55e;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    @media (max-width: 1024px) {
        .base-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="base-container">
    <div class="base-header">
        <h1><i class="ri-map-pin-fill" style="color: var(--accent);"></i> Registrar Base</h1>
        <p>Utilize o mapa iZurvive abaixo para encontrar suas coordenadas e registre sua base.</p>
        <div
            style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; max-width: 800px; margin-left: auto; margin-right: auto;">
            <p style="margin: 0; color: var(--accent); font-size: 0.95rem;">
                <i class="ri-information-line"></i> <strong>Como usar:</strong> Clique no mapa iZurvive para navegar. As
                coordenadas aparecem no canto superior esquerdo do mapa. Copie os valores X e Y e cole nos campos ao
                lado.
            </p>
        </div>
    </div>

    <div class="base-grid">
        <div class="map-section">
            <iframe src="https://www.izurvive.com/chernarusplussatmap/" width="100%" height="100%" frameborder="0"
                style="border:0;" allowfullscreen></iframe>
        </div>

        <div class="info-section">
            <h2>Informações da Base</h2>

            <div id="registration-form">
                <div class="info-card">
                    <h3><i class="ri-map-pin-2-fill" style="color: var(--accent);"></i> Coordenadas</h3>
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                        <i class="ri-cursor-line"></i> Clique no mapa iZurvive ao lado e copie as coordenadas que
                        aparecem no canto superior esquerdo, ou use o GPS do jogo.
                    </p>
                    <div class="coord-inputs">
                        <div>
                            <label><i class="ri-arrow-left-right-line"></i> Coordenada X</label>
                            <input type="number" id="coord-x" class="search-input" placeholder="Ex: 7500" min="0"
                                max="15360" step="1">
                            <small
                                style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 0.25rem;">Valor
                                entre 0 e 15360</small>
                        </div>
                        <div>
                            <label><i class="ri-arrow-up-down-line"></i> Coordenada Z</label>
                            <input type="number" id="coord-z" class="search-input" placeholder="Ex: 9200" min="0"
                                max="15360" step="1">
                            <small
                                style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 0.25rem;">Valor
                                entre 0 e 15360</small>
                        </div>
                    </div>
                    <div
                        style="margin-top: 1rem; padding: 0.75rem; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 0.5rem;">
                        <p style="margin: 0; font-size: 0.85rem; color: #22c55e;">
                            <i class="ri-lightbulb-line"></i> <strong>Dica:</strong> No mapa iZurvive, mova o mouse e
                            veja as coordenadas mudando no canto superior esquerdo. Quando encontrar o local desejado,
                            copie os valores.
                        </p>
                    </div>
                </div>

                <div class="info-card">
                    <h3>Nome da Base (Opcional)</h3>
                    <input type="text" id="base-name" class="search-input" placeholder="Ex: Fortaleza do Texas"
                        maxlength="50">
                </div>

                <div class="info-card">
                    <h3>Raio de Proteção</h3>
                    <p style="color: var(--text-secondary);">50 metros (padrão)</p>
                    <small>Apenas membros do seu clã poderão construir nesta área</small>
                </div>

                <div class="warning-box">
                    <strong><i class="ri-alert-line"></i> ATENÇÃO:</strong><br>
                    • Você só pode registrar 1 base<br>
                    • A localização não pode ser alterada depois<br>
                </div>

                <button class="register-btn" id="register-btn" onclick="registerBase()">
                    <i class="ri-save-line"></i> Registrar Base
                </button>
            </div>

            <div id="success-message" style="display: none;" class="success-box">
                <i class="ri-checkbox-circle-line"></i> Base registrada com sucesso!
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    async function registerBase() {
        const coordX = document.getElementById('coord-x').value;
        const coordZ = document.getElementById('coord-z').value;
        const baseName = document.getElementById('base-name').value || null;

        if (!coordX || !coordZ) {
            alert('Por favor, insira as coordenadas X e Z!');
            return;
        }

        // Validar range
        if (coordX < 0 || coordX > 15360 || coordZ < 0 || coordZ > 15360) {
            alert('Coordenadas inválidas! Use valores entre 0 e 15360.');
            return;
        }

        const btn = document.getElementById('register-btn');
        btn.disabled = true;
        btn.textContent = 'Registrando...';

        try {
            const response = await fetch('/api/base/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    coord_x: parseInt(coordX),
                    coord_y: parseInt(coordZ), // Backend espera coord_y mas é o Z do jogo
                    coord_z: 0,
                    name: baseName
                })
            });

            const data = await response.json();

            if (response.ok) {
                document.getElementById('registration-form').style.display = 'none';
                document.getElementById('success-message').style.display = 'block';
                setTimeout(() => {
                    window.location.href = '/clan';
                }, 2000);
            } else {
                alert(data.error || 'Erro ao registrar base');
                btn.disabled = false;
                btn.innerHTML = '<i class="ri-save-line"></i> Registrar Base';
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao registrar base');
            btn.disabled = false;
            btn.innerHTML = '<i class="ri-save-line"></i> Registrar Base';
        }
    }

    // Validação em tempo real
    document.addEventListener('DOMContentLoaded', function () {
        const coordX = document.getElementById('coord-x');
        const coordZ = document.getElementById('coord-z');
        const btn = document.getElementById('register-btn');

        function validateCoords() {
            const x = coordX.value;
            const z = coordZ.value;

            if (x && z && x >= 0 && x <= 15360 && z >= 0 && z <= 15360) {
                btn.disabled = false;
                btn.style.opacity = '1';
            } else {
                btn.disabled = true;
                btn.style.opacity = '0.5';
            }
        }

        coordX.addEventListener('input', validateCoords);
        coordZ.addEventListener('input', validateCoords);

        // Inicializar como desabilitado
        btn.disabled = true;
        btn.style.opacity = '0.5';
    });
</script>

<!-- Sistema de Notificações -->
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
{% endblock %}